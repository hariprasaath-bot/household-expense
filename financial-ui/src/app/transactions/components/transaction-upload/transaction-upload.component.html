<section class="custom-primeng p-3">
    <div class="upload-styles mb-4">
        <div (click)="startProgress()" pRipple [ngClass]="{'progress-style': showProgressBar}"
            [ngStyle]="{'--p-ripple-background': 'rgba(210, 105, 30, 0.43)'}" 
            class="custom-upload-button p-3 border-round-md border-1 border-primary">
            <div *ngIf="showProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                [style.width.%]="progressValue">
            </div>
            <i *ngIf="!showProgressBar" class="pi pi-file-arrow-up mr-2" style="font-size: 24px;"></i>
            <span *ngIf="!showProgressBar">Upload Statement</span>
            <input hidden type="file" (change)="onFileSelected($event)" #uploader accept=".csv,.xlsx" />
        </div>
        <div *ngIf="showProgressBar" class="progress-text flex align-items-center mt-2">
            <i class="pi pi-spin pi-spinner mr-2" style="font-size: 16px;"></i>
            <span class="text-sm">{{ progressMessage }} {{ progressValue }}%</span>
        </div>
    </div>
    
    <div class="transaction-table-section">
        <div class="flex flex-column gap-3 mb-4">
            <div class="flex align-items-center gap-3 mb-2">
                <div class="flex flex-wrap gap-2">
                    <button pButton 
                            type="button" 
                            label="This Week" 
                            (click)="setDateRange('week')" 
                            class="p-button-sm"
                            [outlined]="activeFilter !== 'week'"
                            [severity]="activeFilter === 'week' ? 'primary' : 'secondary'">
                    </button>
                    <button pButton 
                            type="button" 
                            label="This Month" 
                            (click)="setDateRange('month')" 
                            class="p-button-sm"
                            [outlined]="activeFilter !== 'month'"
                            [severity]="activeFilter === 'month' ? 'primary' : 'secondary'">
                    </button>
                    <button pButton 
                            type="button" 
                            label="Last 3 Months" 
                            (click)="setDateRange('threeMonths')" 
                            class="p-button-sm"
                            [outlined]="activeFilter !== 'threeMonths'"
                            [severity]="activeFilter === 'threeMonths' ? 'primary' : 'secondary'">
                    </button>
                    <button pButton 
                            type="button" 
                            label="Custom Range" 
                            (click)="setDateRange('custom')" 
                            class="p-button-sm"
                            [outlined]="activeFilter !== 'custom'"
                            [severity]="activeFilter === 'custom' ? 'primary' : 'secondary'">
                    </button>
                </div>
            </div>
            
            <div class="flex align-items-center gap-3" *ngIf="activeFilter === 'custom'">
                <p-calendar [(ngModel)]="dateRange" 
                          selectionMode="range" 
                          [readonlyInput]="true" 
                          placeholder="Select Date Range" 
                          [showIcon]="true" 
                          inputId="range" 
                          appendTo="body"
                          styleClass="w-full md:w-25rem"
                          [showOnFocus]="false"
                          [showButtonBar]="true"
                          (onSelect)="onDateSelect($event)">
                </p-calendar>
                <button pButton 
                        pRipple 
                        type="button" 
                        icon="pi pi-filter" 
                        (click)="applyDateFilter()" 
                        class="p-button-outlined"
                        [disabled]="!dateRange || !dateRange[0] || !dateRange[1]"
                        label="Apply Filter"
                        styleClass="p-button-sm">
                </button>
                <button pButton 
                        pRipple 
                        type="button" 
                        icon="pi pi-times" 
                        (click)="clearDateFilter()" 
                        class="p-button-outlined p-button-danger"
                        [disabled]="!dateRange"
                        label="Clear"
                        styleClass="p-button-sm">
                </button>
            </div>
            <div>
                <button pButton 
                        pRipple 
                        type="button" 
                        icon="pi pi-pencil" 
                        (click)="openBatchUpdate()" 
                        class="p-button-success"
                        [disabled]="!dt || !dt.selection || dt.selection.length === 0"
                        label="Edit Selected ({{dt?.selection?.length || 0}})"
                        styleClass="p-button-sm">
                </button>
            </div>
        </div>

        <p-table #dt
                [value]="transactions"
                [(selection)]="selectedTransactions"
                [paginator]="true"
                [rows]="10"
                dataKey="transactionId"
                [globalFilterFields]="['transactionId', 'aiGeneratedCategory', 'aiGeneratedTransactionParty', 'category', 'remark', 'transactionType', 'userId']"
                [showCurrentPageReport]="true"
                currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                [rowsPerPageOptions]="[5,10,20]"
                [responsive]="true"
                [rowHover]="true"
                [resizableColumns]="true">
            
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 3rem">
                        <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                    </th>
                    <th pSortableColumn="transactionId">
                        Transaction ID <p-sortIcon field="transactionId"></p-sortIcon>
                    </th>
                    <th pSortableColumn="aiGeneratedCategory">
                        AI Category <p-sortIcon field="aiGeneratedCategory"></p-sortIcon>
                    </th>
                    <th pSortableColumn="aiGeneratedTransactionParty">
                        Party <p-sortIcon field="aiGeneratedTransactionParty"></p-sortIcon>
                    </th>
                    <th pSortableColumn="balance">
                        Balance <p-sortIcon field="balance"></p-sortIcon>
                    </th>
                    <th pSortableColumn="category">
                        Category <p-sortIcon field="category"></p-sortIcon>
                    </th>
                    <th pSortableColumn="deposit">
                        Deposit <p-sortIcon field="deposit"></p-sortIcon>
                    </th>
                    <th pSortableColumn="withdraw">
                        Withdraw <p-sortIcon field="withdraw"></p-sortIcon>
                    </th>
                    <th pSortableColumn="transactionType">
                        Type <p-sortIcon field="transactionType"></p-sortIcon>
                    </th>
                    <th pSortableColumn="recordDate">
                        Record Date <p-sortIcon field="recordDate"></p-sortIcon>
                    </th>
                    <th pSortableColumn="remark">
                        Remark <p-sortIcon field="remark"></p-sortIcon>
                    </th>
                </tr>
                <tr>
                    <th></th>
                    <th>
                        <input pInputText type="text" (input)="onInput($event, 'transactionId')" 
                               placeholder="Search ID" class="p-column-filter w-full">
                    </th>
                    <th>
                        <input pInputText type="text" (input)="onInput($event, 'aiGeneratedCategory')" 
                               placeholder="Search Category" class="p-column-filter w-full">
                    </th>
                    <th>
                        <input pInputText type="text" (input)="onInput($event, 'aiGeneratedTransactionParty')" 
                               placeholder="Search Party" class="p-column-filter w-full">
                    </th>
                    <th></th>
                    <th>
                        <input pInputText type="text" (input)="onInput($event, 'category')" 
                               placeholder="Search Category" class="p-column-filter w-full">
                    </th>
                    <th></th>
                    <th></th>
                    <th>
                        <input pInputText type="text" (input)="onInput($event, 'transactionType')" 
                               placeholder="Search Type" class="p-column-filter w-full">
                    </th>
                    <th></th>
                    <th>
                        <input pInputText type="text" (input)="onInput($event, 'remark')" 
                               placeholder="Search Remark" class="p-column-filter w-full">
                    </th>
                </tr>
            </ng-template>
            
            <ng-template pTemplate="body" let-transaction>
                <tr [pSelectableRow]="transaction" [pSelectableRowIndex]="transaction.transactionId">
                    <td>
                        <p-tableCheckbox [value]="transaction"></p-tableCheckbox>
                    </td>
                    <td>{{transaction.transactionId}}</td>
                    <td>{{transaction.aiGeneratedCategory}}</td>
                    <td>{{transaction.aiGeneratedTransactionParty}}</td>
                    <td class="text-right">{{transaction.balance | currency:'INR':'symbol':'1.2-2'}}</td>
                    <td>
                        <span class="p-tag" [ngClass]="'category-' + (transaction.category | lowercase)">
                            {{transaction.category || 'UNKNOWN'}}
                        </span>
                    </td>
                    <td class="text-right">
                        <span *ngIf="transaction.deposit > 0" class="text-green-500">
                            +{{transaction.deposit | currency:'INR':'symbol':'1.2-2'}}
                        </span>
                    </td>
                    <td class="text-right">
                        <span *ngIf="transaction.withdraw > 0" class="text-red-500">
                            -{{transaction.withdraw | currency:'INR':'symbol':'1.2-2'}}
                        </span>
                    </td>
                    <td>
                        <span [ngClass]="{
                            'bg-blue-100 text-blue-800': transaction.transactionType === 'CREDIT',
                            'bg-red-100 text-red-800': transaction.transactionType === 'DEBIT'
                        }" class="p-1 text-xs font-medium px-2.5 py-0.5 rounded">
                            {{transaction.transactionType}}
                        </span>
                    </td>
                    <td>{{transaction.recordDate.$date | date:'mediumDate'}}</td>
                    <td class="truncate max-w-xs" [pTooltip]="transaction.remark" tooltipPosition="top">
                        {{transaction.remark}}
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <!-- Batch Update Dialog -->
    <p-dialog header="Batch Update Transactions" 
              [(visible)]="displayDialog" 
              [modal]="true" 
              [style]="{ width: '500px' }"
              [draggable]="false" 
              [resizable]="false"
              (onShow)="onDialogShow()"
              (onHide)="onDialogHide()">
        
        <div class="p-fluid">
            <div class="field mb-4">
                <label for="category" class="block text-900 font-medium mb-2">Category</label>
                <div class="flex align-items-center gap-2">
                    <p-dropdown id="category"
                              [options]="categories" 
                              [(ngModel)]="batchUpdateModel.category" 
                              (onChange)="onCategoryChange($event)"
                              optionLabel="label"
                              optionValue="value"
                              placeholder="Select a category"
                              [showClear]="true"
                              styleClass="w-full">
                        <ng-template let-category pTemplate="item">
                            <div class="flex align-items-center">
                                <i [class]="'mr-2 ' + (category.value === 'add-new' ? 'pi pi-plus' : 'pi pi-tag')"></i>
                                <div>{{category.label}}</div>
                            </div>
                        </ng-template>
                    </p-dropdown>
                    <button pButton 
                            type="button" 
                            icon="pi pi-plus" 
                            class="p-button-outlined"
                            (click)="showNewCategoryInput = true; batchUpdateModel.category = null"
                            pTooltip="Add new category"
                            tooltipPosition="top"></button>
                </div>
                
                <div class="mt-3 p-3 border-round border-1 surface-border" *ngIf="showNewCategoryInput">
                    <div class="grid">
                        <div class="col-12">
                            <label for="newCategoryName" class="block text-sm font-medium mb-2">New Category Name</label>
                            <input id="newCategoryName" 
                                   type="text" 
                                   pInputText 
                                   [(ngModel)]="newCategoryName" 
                                   class="w-full" 
                                   (keyup.enter)="addNewCategory()"
                                   placeholder="Enter category name"/>
                        </div>
                        <div class="col-12 mt-3">
                            <label for="newCategorySearchString" class="block text-sm font-medium mb-2">Search String (comma-separated)</label>
                            <input id="newCategorySearchString" 
                                   type="text" 
                                   pInputText 
                                   [(ngModel)]="newCategorySearchString" 
                                   class="w-full" 
                                   (keyup.enter)="addNewCategory()"
                                   placeholder="e.g. swiggy, zomato"/>
                        </div>
                        <div class="col-12 mt-3">
                            <label for="categoryType" class="block text-sm font-medium mb-2">Type</label>
                            <p-dropdown id="categoryType"
                                      [options]="categoryTypes" 
                                      [(ngModel)]="selectedCategoryType"
                                      optionLabel="label"
                                      optionValue="value"
                                      styleClass="w-full">
                            </p-dropdown>
                        </div>
                        <div class="col-12 mt-3 flex justify-content-end gap-2">
                            <button pButton 
                                    type="button" 
                                    label="Cancel" 
                                    class="p-button-text p-button-sm"
                                    (click)="showNewCategoryInput = false"></button>
                            <button pButton 
                                    type="button" 
                                    label="Add" 
                                    class="p-button-sm"
                                    (click)="addNewCategory()"
                                    [disabled]="!newCategoryName.trim()"></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="field">
                <label for="remark" class="block text-900 font-medium mb-2">Remarks</label>
                <textarea id="remark" 
                         pInputTextarea 
                         [(ngModel)]="batchUpdateModel.remark" 
                         rows="3"
                         placeholder="Add any additional notes..."
                         class="w-full"></textarea>
            </div>
            
            <div class="mt-3 text-sm text-500 flex align-items-center">
                <i class="pi pi-info-circle mr-2"></i>
                This will update {{dt?.selection?.length || 0}} selected transactions
            </div>
        </div>
        
        <ng-template pTemplate="footer">
            <button pButton 
                    pRipple 
                    type="button" 
                    icon="pi pi-times" 
                    label="Cancel" 
                    (click)="displayDialog = false"
                    class="p-button-text">
            </button>
            <button pButton 
                    pRipple 
                    type="button" 
                    icon="pi pi-check" 
                    label="Update" 
                    (click)="submitBatchUpdate()"
                    class="p-button-success">
            </button>
        </ng-template>
    </p-dialog>
    
    <!-- Toast for notifications -->
    <p-toast></p-toast>
</section>